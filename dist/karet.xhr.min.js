!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("karet.lift"),require("infestines"),require("kefir"),require("kefir.partial.lenses")):"function"==typeof define&&define.amd?define(["exports","karet.lift","infestines","kefir","kefir.partial.lenses","partial.lenses.validation"],t):t(((e=e||self).karet=e.karet||{},e.karet.xhr={}),e.karet.lift,e.I,e.Kefir,e.Kefir.partial.lenses)}(this,function(e,t,l,r,y,n){"use strict";function h(e){try{return JSON.parse(e)}catch(e){return null}}function u(e){return e instanceof r.Observable}function i(e){return u(e)?e:r.constant(e)}function o(e){return e instanceof r.Stream?e.toProperty():e}function s(e){return e.toLowerCase()}function a(e){return e}function m(e){return null==e}function c(e){return 200<=e&&e<300}function d(e,t){return{event:{loaded:(y.get(R,e[k])||0)+(y.get(R,t[k])||0),total:(y.get(C,e[k])||0)+(y.get(C,t[k])||0)},type:(r=e[F],n=t[F],V.indexOf(r)<V.indexOf(n)?r:n)};var r,n}function p(e,t){return{down:d(e[S],t[S]),event:t[k][F]===A?e[k]:t[k],map:t.map,up:d(e.up,t.up),xhr:t.xhr}}function f(e){return{down:G,event:K,map:l.id,up:J,xhr:{getAllResponseHeaders:dt,getResponseHeader:pt,readyState:4,response:e,status:200,statusText:"OK"}}}var g="value",v=l.inherit(function(e){r.Property.call(this),this.s=e,this.h=this.t=0},r.Property,{_onActivation:function(){var r=this;r.t?(clearTimeout(r.t),r.t=0):r.s.onAny(r.h=function(e){var t=e.type;t===g?r._emitValue(e[g]):"end"===t?r._emitEnd():r._emitError(e[g])})},_onDeactivation:function(){var e=this;e.t=setTimeout(function(){e.s.offAny(e.h),e.h=e.t=0},0)}}),w=r.never(),H=l.curry(function(e,t){return u(t)?t.skipDuplicates(e):t})(l.acyclicEqualsU),x=l.curry(function(e,t){if(u(t))return t.filter(e);if(e(t))return t;throw Error(e.name)}),T=l.curry(function(e,t){return u(t)?o(t.flatMapLatest(l.pipe2U(e,i))):o(e(t))}),E=l.curry(function(e,t){return u(t)?o(t.map(e)):e(t)}),O="addEventListener",S="down",b="error",k="event",U="initial",L="json",P="load",R="loaded",A="loadend",I="loadstart",q="progress",M="readyState",N="responseType",_="status",j="timeout",C="total",F="type",X="up",z="withCredentials",D="xhr",J=l.freeze({type:U}),K=l.freeze({type:A}),G=l.freeze({type:P}),V=[I,q,P,j,b],W=["overrideMimeType",N,j,z],B=(0,l.id)(function(f){return e=r.stream(function(e){function t(t,r){return function(e){r===q&&d[t].type===P||n(d=y.set(t,{event:e,type:r},d))}}var n=e.emit,r=e.end,u=f.method,i=f.user,o=f.password,s=f.headers,a=f.body,c=new XMLHttpRequest,d={down:J,map:l.id,up:J,xhr:c};for(var p in V.forEach(function(e){c[O](e,t(S,e)),c.upload[O](e,t(X,e))}),c[O]("readystatechange",function(e){n(d=y.set(k,e,d))}),c[O](A,function(e){r(n(d=y.set(k,e,d)))}),c.open(m(u)?"GET":u,f.url,!0,m(i)?null:i,m(o)?null:o),W.forEach(function(e){var t=f[e];t&&(c[e]=t)}),f[N]===L&&c[N]!==L&&(d=y.set("map",h,d)),s)c.setRequestHeader(p,s[p]);return c.send(m(a)?null:a),function(){c[_]||c.abort()}}),new v(e);var e}),Q=y.get([y.array(y.cross([y.reread(s),y.identity])),y.inverse(y.keyed)]),Y=(0,l.id)(y.transform(y.ifElse(l.isString,y.modifyOp(function(e){return{headers:l.object0,url:e}}),y.branch({headers:y.cond([m,y.setOp(l.object0)],[l.isArray,y.modifyOp(Q)],[function(e){return l.isFunction(e.keys)},y.modifyOp(l.pipe2U(Array.from,Q))],[[y.keys,y.modifyOp(s)]])})))),Z=a(l.pipe2U(Y,T(B))),$=l.curry(function(e,t){return e.includes(t)}),ee=l.curry(function(e,t){return y.get([t,F,$(e)])}),te=ee(V),re=ee([q,I]),ne=ee([P]),ue=ee([b]),ie=ee([j]),oe=ee([P,j,b]),se=ee([b,j]),ae=l.curry(function(e,t,r){return t([r,k,e])}),ce=ae(R,y.sum),de=ae(C,y.sum),pe=ae(b),fe=l.curryN(3,function(e,t){return l.pipe2U(x(e),t)}),le=y.branches(S,X),ye=a(te(X)),he=a(re(X)),me=a(ne(X)),ge=a(ue(X)),ve=a(ue(X)),we=a(ie(X)),He=a(oe(X)),xe=a(ce(X)),Te=a(de(X)),Ee=a(pe(y.get,X)),Oe=a(te(S)),Se=a(re(S)),be=a(ne(S)),ke=a(se(S)),Ue=a(ue(S)),Le=a(ie(S)),Pe=a(oe(S)),Re=a(ce(S)),Ae=a(de(S)),Ie=a(pe(y.get,S)),qe=a(y.get([D,M])),Me=a(y.get([D,M,function(e){return 2<=e}])),Ne=a(ee([A],k)),_e=a(re(le)),je=a(ue(le)),Ce=a(ie(le)),Fe=a(ce(le)),Xe=a(de(le)),ze=a(l.pipe2U(pe(y.collect,le),H)),De=a(fe(be,l.pipe2U(t.lift(function(e){return(0,e.map)(e.xhr.response)}),H))),Je=a(y.get([D,N])),Ke=a(fe(Me,y.get([D,"responseURL"]))),Ge=a(y.get([D,y.when(y.get([N,$(["","text"])])),"responseText"])),Ve=a(fe(be,y.get([D,y.when(y.get([N,$(["","document"])])),"responseXML"]))),We=a(fe(Me,y.get([D,_]))),Be=a(y.get([D,_,c])),Qe=a(fe(Me,y.get([D,"statusText"]))),Ye=l.curryN(2,function(t){return fe(Me,y.get([D,y.reread(function(e){return e.getResponseHeader(t)})]))}),Ze=a(fe(Me,y.get([D,y.reread(function(e){return e.getAllResponseHeaders()})]))),$e=a(y.get([D,j])),et=a(y.get([D,z])),tt=t.lift(c),rt=t.lift(function(e,t){var r=l.assign({},e.headers,t.headers);return l.assign({},e,t,{headers:r})}),nt=l.curry(function(e,t){return Z(rt(Y(e),Y(t)))}),ut=a(nt({headers:{"Content-Type":"application/json"},responseType:L})),it=[F,$([U,P])],ot=a(y.and(y.branch({down:it,event:[F,y.is(A)],up:it,xhr:[_,c]}))),st=t.lift(function(e){return Me(e)&&!Be(e)||ke(e)||ge(e)}),at=a(l.pipe2U(ut,T(function(e){return ot(e)?De(e):Ne(e)&&(je(e)||Ce(e))?r.constantError(e):w}))),ct=a(fe(ot,De)),dt=l.always(""),pt=l.always(null),ft=l.curryN(2,function(e){return T(function(t){return ot(t)?E(function(e){return st(e)?e:p(t,e)},e(De(t))):t})}),lt=l.curryN(2,function(t){return ft(function(e){return f(t(e))})}),yt=l.curry(function(e,t){return ft(function(e){return lt(e,t)},e)}),ht=l.Monad(lt,f,yt,ft),mt=l.curry(function(e,r){return T(function(t){return st(t)?t:E(function(e){return ot(t)?ot(e)?p(p(t,e),f(De(t)(De(e)))):st(e)?e:p(t,e):p(t,e)},r)},e)}),gt=l.Applicative(lt,f,mt),vt=[F,l.isString],wt=a(y.and(y.branch({down:vt,map:l.isFunction,up:vt,xhr:[M,l.isNumber]}))),Ht=l.IdentityOrU(wt,ht),xt=l.IdentityOrU(wt,gt),Tt=a(y.get([y.traverse(xt,l.id,t.inTemplate(wt)),y.ifElse(wt,[],f)])),Et=l.curry(function(t,e){return lt(function(e){return t.apply(null,e)},Tt(e))}),Ot=l.curryN(2,function(t){return lt(function(e){return t(e),e})});e.IdentityParallel=xt,e.IdentitySucceeded=Ht,e.Parallel=gt,e.Succeeded=ht,e.allResponseHeaders=Ze,e.ap=yt,e.apParallel=mt,e.apply=Et,e.chain=ft,e.downError=Ie,e.downHasCompleted=be,e.downHasEnded=Pe,e.downHasErrored=Ue,e.downHasFailed=ke,e.downHasStarted=Oe,e.downHasTimedOut=Le,e.downIsProgressing=Se,e.downLoaded=Re,e.downTotal=Ae,e.errors=ze,e.getJson=at,e.hasErrored=je,e.hasFailed=st,e.hasSucceeded=ot,e.hasTimedOut=Ce,e.isDone=Ne,e.isHttpSuccess=tt,e.isProgressing=_e,e.isStatusAvailable=Me,e.isXHR=wt,e.loaded=Fe,e.map=lt,e.of=f,e.perform=Z,e.performJson=ut,e.performWith=nt,e.readyState=qe,e.response=De,e.responseHeader=Ye,e.responseText=Ge,e.responseType=Je,e.responseURL=Ke,e.responseXML=Ve,e.result=ct,e.status=We,e.statusIsHttpSuccess=Be,e.statusText=Qe,e.tap=Ot,e.template=Tt,e.timeout=$e,e.total=Xe,e.upError=Ee,e.upHasCompleted=me,e.upHasEnded=He,e.upHasErrored=ve,e.upHasFailed=ge,e.upHasStarted=ye,e.upHasTimedOut=we,e.upIsProgressing=he,e.upLoaded=xe,e.upTotal=Te,e.withCredentials=et,Object.defineProperty(e,"__esModule",{value:!0})});
